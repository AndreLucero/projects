<a
    [routerLink]="['/chatApp', conversation.id]"
    routerLinkActive="bg-gray-300"
    class="flex py-4 gap-2 justify-center items-center shadow inset-shadow-xs cursor-pointer hover:bg-violet-200 active:bg-violet-300 relative"
    [cdkContextMenuTriggerFor]="context_menu"
>
    <div class="w-min">
        <div [class]="`shadow inset-shadow-sm h-12 w-12 p-2 bg-${conversation.color}-500 rounded-full text-white font-semibold flex items-center justify-center uppercase`">{{ conversation.alias }}</div>
    </div>
    <div class="w-3/4">
        <div class="text-lg font-semibold">{{ conversation.conversationName }}</div>
        <span class="text-gray-500 flex truncate text-ellipsis">{{ conversation.messages.at(-1)?.text }}</span>
    </div>
    @if( countLastResponse > 0 ){
        <span class="inline-flex items-center justify-center w-6 h-6 ms-2 text-xs font-semibold text-violet-800 bg-violet-200 rounded-full absolute top-1/2 end-1 -translate-1/2">{{countLastResponse}}</span>
    }

</a>


<ng-template #context_menu>
    <div class="grid gap-1 z-99 bg-white text-gray-400 w-40 p-1 rounded shadow-lg" cdkMenu>

        <button class="flex justify-between items-center px-1 cursor-pointer hover:bg-violet-400 hover:text-white" cdkMenuItem (cdkMenuItemTriggered)="cdkParticipantsInfo()">
            <span>Ver Participantes</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M11 17.5a6.47 6.47 0 0 1 1.022-3.5h-6.77a2.25 2.25 0 0 0-2.248 2.249v.92c0 .572.178 1.13.51 1.596C5.056 20.929 7.58 22 11 22q.9 0 1.717-.099A6.48 6.48 0 0 1 11 17.5m0-15.495a5 5 0 1 1 0 10a5 5 0 0 1 0-10M23 17.5a5.5 5.5 0 1 1-11 0a5.5 5.5 0 0 1 11 0m-9.5 0a4 4 0 1 0 8 0a4 4 0 0 0-8 0m5-2a1 1 0 1 1-2 0a1 1 0 0 1 2 0m-.25 2.5a.75.75 0 0 0-1.5 0v1.75a.75.75 0 0 0 1.5 0z"/></svg>
        </button>

        <button class="flex justify-between items-center px-1 cursor-pointer hover:bg-violet-400 hover:text-white" cdkMenuItem (cdkMenuItemTriggered)="cdkCreateInvitation()">
            <span>Crear Invitación</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M5.5 15a3.478 3.478 0 0 0 2.357-.93l6.26 3.577a3.52 3.52 0 1 0 1.026-1.717l-6.26-3.577c.066-.25.102-.509.108-.768l6.15-3.515A3.489 3.489 0 1 0 14 5.5c.004.288.043.575.117.853L8.433 9.6A3.5 3.5 0 1 0 5.5 15Z"/></svg>            
        </button>

        <hr class="my-1 text-gray-300">

        <button class="flex justify-between items-center px-1 cursor-pointer hover:bg-red-500 hover:text-white" cdkMenuItem (cdkMenuItemTriggered)=" dialogConfirmationExit = true ">
            <span>Salir del chat</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M4 5h3V4a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1h3a1 1 0 0 1 0 2h-1v13a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V7H4a1 1 0 1 1 0-2m3 2v13h10V7zm2-2h6V4H9zm0 4h2v9H9zm4 0h2v9h-2z"/></svg>
        </button>

    </div>
</ng-template>

<p-dialog [modal]="true" [(visible)]="dialogParticipantsInfo" header="Información de Participantes" [dismissableMask]="true">
    
    <div class="p-2">
        
        @for (user of participantsInfo; track $index) {
            <div class="flex p-2 gap-2 bg-white ring ring-gray-300 cursor-pointer hover:bg-gray-100">
                @if( user.avatar; as avatar){
                    <img 
                        [src]="`assets/img/avatars/${avatar}`"
                        [alt]="avatar"
                        class="rounded-full size-10"
                    >
                }@else {
                    <div
                        class="h-10 w-10 p-2  rounded-full text-white font-semibold flex items-center justify-center"
                        [class]="`bg-${ user?.color ?? 'gray' }-500`"
                    >{{ user.alias }}</div>
                }

                <div class="grid text-sm text-gray-500">
                    <span>{{user?.nombre}}</span>
                    <span class="text-[10px]">{{user?.id}}</span>
                </div>

            </div>
        }

    </div>

</p-dialog>

<p-dialog [modal]="true" [(visible)]="dialogInvitationChat" header="Invitación para unirse al chat" [dismissableMask]="true">
    <div class="h-full flex p-2 gap-2 justify-center items-center w-xl">

        <span class="font-medium">Invitación:</span>
        
        <div class="flex gap-0 rounded overflow-hidden w-full">

            <input
                type="text"
                class="p-3 bg-gray-200 shadow-[inset_0px_0px_4px_gray] grow"
                [ngModel]="invitationLink"
                disabled
            >
            <button class="bg-violet-500 p-3 text-white cursor-pointer hover:bg-violet-600" (click)="copyLink()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 16 16"><path fill="currentColor" fillRule="evenodd" d="M9.929 3.132a2.078 2.078 0 1 1 2.94 2.94l-.65.648a.75.75 0 0 0 1.061 1.06l.649-.648a3.579 3.579 0 0 0-5.06-5.06L6.218 4.72a3.58 3.58 0 0 0 0 5.06a.75.75 0 0 0 1.061-1.06a2.08 2.08 0 0 1 0-2.94zm-.15 3.086a.75.75 0 0 0-1.057 1.064c.816.81.818 2.13.004 2.942l-2.654 2.647a2.08 2.08 0 0 1-2.94-2.944l.647-.647a.75.75 0 0 0-1.06-1.06l-.648.647a3.58 3.58 0 0 0 5.06 5.066l2.654-2.647a3.575 3.575 0 0 0-.007-5.068Z" clipRule="evenodd"/></svg>
            </button>

        </div>
        
    </div>
</p-dialog>

<p-dialog [modal]="true" [(visible)]="dialogConfirmationExit" header="¿Estas seguro que deseas salir del chat?" [dismissableMask]="true">
    <div class="flex gap-4 px-7">
        <button class="bg-violet-400 rounded py-1 text-white w-full cursor-pointer hover:bg-violet-500" (click)="cdkExitChat()">Salir</button>
        <button class="bg-red-400 rounded py-1 text-white w-full cursor-pointer hover:bg-red-500" (click)=" dialogConfirmationExit = false">Cancelar</button>
    </div>
</p-dialog>

<p-toast position="bottom-right" key="toastCopyLink" />